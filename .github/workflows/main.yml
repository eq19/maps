# 💎 Main Workflow - eQuantum MEC Structure
name: Build and Deploy Cell Types – Modulo 6

on:
  push:
    paths:
      - '.*/**'
      - '!**/reserves/**'
  workflow_run:
    types: [completed]
    workflows: ["pages-build-deployment"]

# ⚠️ Allow concurrent
concurrency:
  group: "pages"
  cancel-in-progress: true

# Set GITHUB_TOKEN
permissions: write-all
        
# Global environtment
env:
  RUN: ${{ github.run_id }}
  USER: ${{ github.actor }}
  REPO: ${{ github.repository }}
  OWNER: ${{ github.repository_owner }}
  ACTOR: ${{ github.triggering_actor }}
  
jobs:
  lexering:
    strategy:
      max-parallel: 1
      fail-fast: true
      matrix:
        #Simulate Gell-Mann
        #node_version: [8, 10, 12]
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    # Runs on workflow_run.conclusion
    if: ${{github.event_name == 'push' ||
        github.event.workflow_run.conclusion == 'success'}}

    steps:
      - name: 📂 Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: ⚙️ Build Maps
        uses: eq19/maps@v1
        if: runner.os == 'Ubuntu'
        with:
          image_name: prime
          token: ${{ secrets.ACCESS_TOKEN }}
          docker_hub_username: ${{ github.actor }}
          docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
          docker_hub_password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: 🏃‍♂️ Feed Mapping
        uses: eq19/feed@v3        
        id: build-image
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          credentials: ${{ secrets.GCP_CREDENTIALS }}

      - name: ♻️ Lexering Cloud
        uses: eq19/lexer@v1
        id: set-runner
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          credentials: ${{ secrets.GCP_CREDENTIALS }}
          
    outputs:
      runner: ${{ steps.set-runner.outputs.use-runner }}

  setup-parser:
    needs: lexering
    strategy:
      matrix:
        os: [self-hosted]
    runs-on: ${{ matrix.os }}
    #runs-on: ubuntu-latest (build-995)
    #runs-on: ${{ fromJson(needs.determine-runner.outputs.runner) }}

    steps:
      - name: 📂 Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: 🪂 Parsering
        uses: eq19/parser@v1

      - name: 🚀 Evaluate Syntax
        uses: eq19/syntax@v2
  
      - name: 🔧 Set Grammar Rules 
        uses: eq19/grammar@v1
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          credentials: ${{ secrets.GCP_CREDENTIALS }}
