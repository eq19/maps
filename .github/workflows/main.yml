# üíé Main Workflow: eQuantum MEC Structure
name: Build and Deploy Cell Types ‚Äì Modulo 6
#
# The semantics for running shell commands in GitHub actions is non-obvious. Please read
# https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsshell
# before modifying this file. Our strategy is to rely on the built-in (unspecified) shell, and
# explicitly set the shell ngs we want (with `set -eo pipefail`) at the beginning of any
# bash script. For more information on these settings, see `man bash`.
#
# GitHub Actions files can be difficult to modify with confidence, because testing changes often
# requires pushing to a branch and running CI remotely. To make this process easier, consider
# the following:
#
# 1) Use Visual Studio Code with the GitHub Actions Extension (github.vscode-github-actions).
#    This allows you to check the validity of your action schema and syntax without pushing to a
#    branch.
# 2) Use https://github.com/nektos/act to run your CI steps locally. Note this will only work with
#    steps run on Linux platforms, as `act` is implemented with Docker containers.
#
on:
  push:
    paths:
      - '.*/**'
      - '!**/reserves/**'
  workflow_run:
    types: [completed]
    workflows: ["pages-build-deployment"]

# ‚ö†Ô∏è Allow concurrent
concurrency:
  group: "pages"
  cancel-in-progress: true

# Set GITHUB_TOKEN
permissions: write-all
        
jobs:
  lexering:
    strategy:
      max-parallel: 1
      fail-fast: true
      matrix:
        #node_version: [8, 10, 12]
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    # Runs on workflow_run.conclusion
    if: ${{github.event_name == 'push' ||
        github.event.workflow_run.conclusion == 'success'}}

    steps:
      - name: üìÇ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: ‚öôÔ∏è Build Maps
        uses: eq19/maps@v1
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          credentials: ${{ secrets.GCP_CREDENTIALS }}
          docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
          docker_hub_password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: üèÉ‚Äç‚ôÇÔ∏è Feed Mapping
        uses: eq19/feed@v3        
        id: build-image
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          credentials: ${{ secrets.GCP_CREDENTIALS }}
          docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
          docker_hub_password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: ‚ôªÔ∏è Lexering Cloud
        uses: eq19/lexer@v1
        id: set-runner
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          credentials: ${{ secrets.GCP_CREDENTIALS }}
          docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
          docker_hub_password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          
    outputs:
      runner: ${{ steps.set-runner.outputs.use-runner }}

  setup-parser:
    needs: lexering
    strategy:
      matrix:
        os: [self-hosted]
            
    # Simulate Gell-Mann           
    runs-on: ${{ matrix.os }}
    #runs-on: ${{ fromJson(needs.determine-runner.outputs.runner) }}

    steps:
      - name: üìÇ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: ü™Ç Parsering
        uses: eq19/parser@v1

      - name: üöÄ Evaluate Syntax
        uses: eq19/syntax@v2
  
      - name: üîß Set Grammar Rules 
        uses: eq19/grammar@v1
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          credentials: ${{ secrets.GCP_CREDENTIALS }}
